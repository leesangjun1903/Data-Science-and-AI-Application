# A Topological Loss Function for Deep-Learning based Image Segmentation using Persistent Homology

# 논문의 핵심 주장 및 기여 요약

**주요 주장**  
이 논문은 딥러닝 기반 이미지(또는 볼륨) 분할 과정에 **토폴로지(위상학) 정보**를 명시적으로 통합하는 새로운 손실 함수를 제안한다. 영속적 호몰로지(persistent homology)를 활용해 객체의 베티 수(Betti numbers)로 원하는 토폴로지 특성을 지정하고, 네트워크의 분할 결과가 해당 특성을 갖추도록 학습시킨다. 이 방식은 픽셀 단위 정답 레이블이 아닌, 객체의 토폴로지에 대한 **사전 지식만**으로도 동작하며, 반(半)지도학습 또는 사후 처리(post-processing) 관점 모두에 적용 가능하다.[1]

**주요 기여**  
1. 영속적 호몰로지의 미분 가능 특성을 이용해 베티 수에 따른 토폴로지 손실 함수를 정의하고, 이를 CNN 학습에 통합할 수 있음을 보였다.  
2. MNIST 노이즈 제거, 심장 벤트리큘러 심근 분할(UK Biobank, ACDC), 3D 초음파 태반 분할 등 네 가지 실험을 통해 픽셀 단위 정확도와 토폴로지 정확도가 모두 향상됨을 입증했다.  
3. 라벨이 없는 데이터에서도 토폴로지 손실만으로 유용한 학습 신호를 추출할 수 있어, 주석 달기 비용이 높은 의료영역에서 실용적임을 보였다.[1]

# 해결하고자 하는 문제, 제안 방법, 모델 구조, 성능 및 한계

## 해결 문제  
기존 분할 손실 함수(교차 엔트로피, Dice 등)는 픽셀 단위 겹침도만 평가하여 전체 구조의 **토폴로지 오류**(예: 연결 성분 누락·과다, 구멍 결손)를 제어하지 못한다. 특히 의료영상에서 구조적·해부학적 제약이 중요한데, 대량의 정확한 라벨 데이터 확보는 비용·시간 면에서 어려움이 크다.

## 제안 방법  
영속적 호몰로지(PH)를 통해 분할(candidate segmentation)의 슈퍼레벨 집합(super-level set)에 나타나는 연결 성분(β₀), 구멍(β₁), 공동(β₂) 등을 계산한다.  
토폴로지 손실은 원하는 베티 수 $$\beta_k^* $$에 대해  

```math
L_k(\beta_k^*) = \sum_{\ell=1}^{\beta_k^*}\bigl(1 - |b_{k,\ell}-d_{k,\ell}|^2\bigr) + \sum_{\ell=\beta_k^*+1}^{\infty}|b_{k,\ell}-d_{k,\ell}|^2
```

$$
L_{\text{topo}} = \sum_k L_k(\beta_k^*)
$$  

로 정의하여, 분할의 영속 바(bar) 길이가 1이 되도록 유도하고 불필요한 바는 0이 되게 한다. 이 손실은 백프로파게이션이 가능하며, 네트워크 가중치에 대한 그래디언트를 제공한다.[1]

## 모델 구조  
제안된 손실 함수는 U-net 계열의 2D/3D CNN 분할기에 플러그인 형태로 통합된다.  
- **사후 처리(Post-processing)**: 학습된 모델 출력에 대해 각 이미지별 $$L_{\text{topo}}$$를 추가 학습하여 토폴로지 교정  
- **반지도학습(Semi-supervised)**: 소수의 라벨 데이터에 Dice 손실, 다수의 무라벨 데이터에 토폴로지 손실을 번갈아 적용

## 성능 향상  
- **MNIST 노이즈 제거**: 토폴로지 후처리 적용 시 분류 정확도 평균 3–6%p 향상, MSE 감소.[1]
- **심근 분할(UK Biobank)**: 고난도(강한 노이즈) 환경에서 Dice 5–10%p 개선, 토폴로지 오류 비율 대폭 감소.[1]
- **ACDC 챌린지**: 사후 처리로 Dice ~0.90 달성, 기존 최고 수준과 동등한 성능  
- **3D 태반 분할(초음파)**: 평균 Dice 0.024p 상승, 잘못된 분절된 컴포넌트·구멍 제거.[1]

## 한계  
- **극단적 오차**: 예측 분할이 토폴로지 목표에서 너무 멀면 전역 최적점에 도달하지 못할 수 있음.  
- **계산 비용**: 2D 배치(100개, 80×80) PH 계산에 약 10초, 3D 볼륨(96×240×256)에 6초 소요. 실시간 적용에는 최적화 필요.  
- **하이퍼파라미터**: 토폴로지 손실 가중치 λ 조정이 분할 정확도·토폴로지 정확도 간 트레이드오프에 중요.

# 일반화 성능 향상 관점

영속적 호몰로지 기반 토폴로지 손실은 **라벨 부족 환경**에서 무라벨 데이터의 구조적 일관성을 강화하여 **과적합**을 억제하고 **일반화**를 돕는다. 특히 의료영상의 소량 주석 문제에 강점이 있다. 사전 지식(토폴로지)만으로 분포 편차가 큰 입력에도 모델이 안정적으로 분할하도록 유도하므로, 다양한 장비·프로토콜·환자군으로 확장 시 강인성이 상승한다.

# 향후 연구 영향 및 고려사항

이 손실 함수는 의료영상 외에도 도로 추출, 천문학 이미지, 뇌 피질 표면 분할 등 **토폴로지 제약이 본질적**인 영역에 적용 가능하다.  
- **다중 클래스 분할**: 클래스 간 경계 위상 제약을 동시에 최적화하는 일반화 필요  
- **토폴로지-모양 하이브리드**: 기존 변형 모델(deformable model)과 결합해 대규모 모양 변형도 다루기  
- **실시간 최적화**: 다운샘플링, GPU 가속 등 계산 최적화로 임상 응용 확대  
- **가중치 스케줄링**: λ 조정 스케줄링으로 초기 픽셀 손실 학습 후 토폴로지 강화 전략 연구

토폴로지 손실의 **유연한 베티 수 지정**, **미분 가능 특성** 및 **사전 지식 활용**은 향후 구조적 안정성이 중요한 분할 연구에 새로운 패러다임을 제시할 것이다.

[1](https://ppl-ai-file-upload.s3.amazonaws.com/web/direct-files/attachments/65988149/3afcbc83-bd81-4806-86b5-40ccab564354/A-Topological-Loss-Function-for-Deep-Learning-based-Image-Segmentation-using-Persistent-Homology.pdf)
